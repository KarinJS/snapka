name: 浏览器安装测试

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - test-browser-installation
  pull_request:
    paths:
      - "packages/playwright-core/src/server/registry/**"
      - ".github/workflows/test_browser_installation.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  FORCE_COLOR: 1

jobs:
  test-installation:
    name: ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux AMD64
          - os: linux
            arch: amd64
            runner: ubuntu-22.04
            shell: bash
          # Linux ARM64
          - os: linux
            arch: arm64
            runner: ubuntu-22.04-arm
            shell: bash
          # macOS Intel
          - os: macos
            arch: amd64
            runner: macos-15-intel
            shell: bash
          # macOS ARM64 (Apple Silicon)
          - os: macos
            arch: arm64
            runner: macos-latest
            shell: bash
          # Windows AMD64
          - os: windows
            arch: amd64
            runner: windows-2022
            shell: pwsh
          # Windows ARM64
          - os: windows
            arch: arm64
            runner: windows-11-arm
            shell: pwsh

    defaults:
      run:
        shell: ${{ matrix.shell }}

    steps:
      - name: 检出代码仓库
        uses: actions/checkout@v4

      - name: 设置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: 安装 pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: 安装项目依赖
        run: |
          echo "=== 正在安装项目依赖 ==="
          pnpm init
          pnpm install playwright
        continue-on-error: false

      - name: 安装 Playwright 浏览器
        id: install-browsers
        run: |
          # 设置日志文件路径
          if [ "$RUNNER_OS" == "Windows" ]; then
            LOG_FILE=$(cygpath -u "$RUNNER_TEMP")/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt
          else
            LOG_FILE="${{ runner.temp }}/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt"
          fi

          echo "" | tee -a "$LOG_FILE"
          echo "=== 正在安装 Playwright 浏览器 ===" | tee -a "$LOG_FILE"
          echo "这将安装所有默认浏览器（chromium、firefox、webkit）" | tee -a "$LOG_FILE"
          echo "" | tee -a "$LOG_FILE"

          # 运行安装并记录完整日志
          npx playwright install 2>&1 | tee -a "$LOG_FILE"

          # 捕获退出码
          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit-code=$EXIT_CODE" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Playwright 安装失败，退出码: $EXIT_CODE"
            exit $EXIT_CODE
          fi

          echo "" | tee -a "$LOG_FILE"
          echo "=== 安装完成 ===" | tee -a "$LOG_FILE"
        shell: bash
        continue-on-error: true

      - name: 使用 Playwright CLI 验证安装
        run: |
          # 设置日志文件路径
          if [ "$RUNNER_OS" == "Windows" ]; then
            LOG_FILE=$(cygpath -u "$RUNNER_TEMP")/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt
          else
            LOG_FILE="${{ runner.temp }}/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt"
          fi

          echo "" | tee -a "$LOG_FILE"
          echo "=== 使用 Playwright CLI 验证安装 ===" | tee -a "$LOG_FILE"
          echo "" | tee -a "$LOG_FILE"

          echo "--- 列出已安装的浏览器 ---" | tee -a "$LOG_FILE"
          npx playwright install --dry-run 2>&1 | tee -a "$LOG_FILE" || true

          echo "" | tee -a "$LOG_FILE"
          echo "--- Playwright 版本 ---" | tee -a "$LOG_FILE"
          npx playwright --version 2>&1 | tee -a "$LOG_FILE"
          echo "" | tee -a "$LOG_FILE"
        shell: bash
        continue-on-error: true

      - name: 执行浏览器查询脚本
        run: |
          # 设置日志文件路径
          if [ "$RUNNER_OS" == "Windows" ]; then
            LOG_FILE=$(cygpath -u "$RUNNER_TEMP")/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt
          else
            LOG_FILE="${{ runner.temp }}/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt"
          fi

          echo "" | tee -a "$LOG_FILE"
          echo "=== 执行浏览器查询脚本 (node index.mjs) ===" | tee -a "$LOG_FILE"
          echo "" | tee -a "$LOG_FILE"

          node index.mjs 2>&1 | tee -a "$LOG_FILE" || true

          echo "" | tee -a "$LOG_FILE"
        shell: bash
        continue-on-error: true

      - name: 生成摘要报告
        if: always()
        id: summary
        run: |
          # 设置日志文件路径
          if [ "$RUNNER_OS" == "Windows" ]; then
            LOG_FILE=$(cygpath -u "$RUNNER_TEMP")/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt
          else
            LOG_FILE="${{ runner.temp }}/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt"
          fi

          echo "=== 正在生成摘要报告 ===" | tee -a "$LOG_FILE"

          {
            echo "## 浏览器安装测试报告"
            echo ""
            echo "### 环境信息"
            echo "- **操作系统**: ${{ matrix.os }}"
            echo "- **架构**: ${{ matrix.arch }}"
            echo "- **运行器**: ${{ matrix.runner }}"
            echo "- **状态**: ${{ steps.install-browsers.outcome }}"
            echo ""

            echo "### 安装结果"
            if [ "${{ steps.install-browsers.outputs.exit-code }}" == "0" ]; then
              echo "✅ **成功** - Playwright 浏览器安装成功"
            else
              echo "❌ **失败** - 安装失败，退出码: ${{ steps.install-browsers.outputs.exit-code }}"
            fi
            echo ""

            echo "### 浏览器根目录"
            if [ "${{ steps.find-browsers.outputs.browser-root }}" == "NOT_FOUND" ]; then
              echo "⚠️ 未找到浏览器根目录"
            else
              echo "\`${{ steps.find-browsers.outputs.browser-root }}\`"
            fi
            echo ""

            echo "### 完整日志"
            echo "详细日志已上传至 Artifacts，文件名: \`test-log-${{ matrix.os }}-${{ matrix.arch }}.txt\`"

          } >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: 上传测试日志
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-log-${{ matrix.os }}-${{ matrix.arch }}
          path: ${{ runner.temp }}/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt
          if-no-files-found: warn
          retention-days: 7

  summary:
    name: 安装测试汇总
    runs-on: ubuntu-latest
    needs: test-installation
    if: always()
    steps:
      - name: 下载所有测试日志
        uses: actions/download-artifact@v4
        with:
          pattern: test-log-*
          path: logs
          merge-multiple: true

      - name: 合并并压缩日志
        run: |
          cd logs
          ls -lh
          zip -9 ../all-test-logs.zip *.txt
          cd ..
          ls -lh all-test-logs.zip

      - name: 上传合并的日志压缩包
        uses: actions/upload-artifact@v4
        with:
          name: all-test-logs
          path: all-test-logs.zip
          retention-days: 30
          compression-level: 0

      - name: 生成测试汇总报告
        run: |
          echo "# 浏览器安装测试汇总" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "所有平台测试已完成。" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 日志文件" >> $GITHUB_STEP_SUMMARY
          echo "所有平台的测试日志已合并压缩至 \`all-test-logs.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 包含的日志文件:" >> $GITHUB_STEP_SUMMARY
          cd logs
          for log in *.txt; do
            size=$(du -h "$log" | cut -f1)
            echo "- \`$log\` ($size)" >> $GITHUB_STEP_SUMMARY
          done
