name: 浏览器安装测试

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - test-browser-installation
  pull_request:
    paths:
      - "packages/playwright-core/src/server/registry/**"
      - ".github/workflows/test_browser_installation.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  FORCE_COLOR: 1

jobs:
  test-installation:
    name: ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux AMD64
          - os: linux
            arch: amd64
            runner: ubuntu-22.04
            shell: bash
          # Linux ARM64
          - os: linux
            arch: arm64
            runner: ubuntu-22.04-arm
            shell: bash
          # macOS Intel
          - os: macos
            arch: amd64
            runner: macos-15-intel
            shell: bash
          # macOS ARM64 (Apple Silicon)
          - os: macos
            arch: arm64
            runner: macos-latest
            shell: bash
          # Windows AMD64
          - os: windows
            arch: amd64
            runner: windows-2022
            shell: pwsh
          # Windows ARM64
          - os: windows
            arch: arm64
            runner: windows-11-arm
            shell: pwsh

    defaults:
      run:
        shell: ${{ matrix.shell }}

    steps:
      - name: 检出代码仓库
        uses: actions/checkout@v4

      - name: 设置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: 安装 pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: 安装项目依赖
        run: |
          echo "=== 正在安装项目依赖 ==="
          pnpm init
          pnpm install playwright
        continue-on-error: false

      - name: 安装 Playwright 浏览器
        id: install-browsers
        run: |
          # 设置日志文件路径
          if [ "$RUNNER_OS" == "Windows" ]; then
            LOG_FILE=$(cygpath -u "$RUNNER_TEMP")/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt
          else
            LOG_FILE="${{ runner.temp }}/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt"
          fi

          echo "" | tee -a "$LOG_FILE"
          echo "=== 正在安装 Playwright 浏览器 ===" | tee -a "$LOG_FILE"
          echo "这将安装所有默认浏览器（chromium、firefox、webkit）" | tee -a "$LOG_FILE"
          echo "" | tee -a "$LOG_FILE"

          # 运行安装并记录完整日志
          npx playwright install 2>&1 | tee -a "$LOG_FILE"

          # 捕获退出码
          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit-code=$EXIT_CODE" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Playwright 安装失败，退出码: $EXIT_CODE"
            exit $EXIT_CODE
          fi

          echo "" | tee -a "$LOG_FILE"
          echo "=== 安装完成 ===" | tee -a "$LOG_FILE"
        shell: bash
        continue-on-error: true

      - name: 查找浏览器根目录
        id: find-browsers
        run: |
          # 设置日志文件路径
          if [ "$RUNNER_OS" == "Windows" ]; then
            LOG_FILE=$(cygpath -u "$RUNNER_TEMP")/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt
          else
            LOG_FILE="${{ runner.temp }}/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt"
          fi

          echo "" | tee -a "$LOG_FILE"
          echo "=== 正在查找浏览器安装目录 ===" | tee -a "$LOG_FILE"
          echo "" | tee -a "$LOG_FILE"

          # 根据操作系统设置搜索路径
          if [ "$RUNNER_OS" == "Windows" ]; then
            SEARCH_PATHS=(
              "$LOCALAPPDATA/ms-playwright"
              "$HOME/AppData/Local/ms-playwright"
            )
          elif [ "$RUNNER_OS" == "macOS" ]; then
            SEARCH_PATHS=(
              "$HOME/Library/Caches/ms-playwright"
            )
          else
            SEARCH_PATHS=(
              "$HOME/.cache/ms-playwright"
              "$XDG_CACHE_HOME/ms-playwright"
            )
          fi

          # 查找实际的浏览器目录
          BROWSER_ROOT=""
          for path in "${SEARCH_PATHS[@]}"; do
            if [ -d "$path" ]; then
              BROWSER_ROOT="$path"
              echo "找到浏览器根目录: $BROWSER_ROOT" | tee -a "$LOG_FILE"
              break
            fi
          done

          if [ -z "$BROWSER_ROOT" ]; then
            echo "::warning::未找到浏览器根目录！" | tee -a "$LOG_FILE"
            echo "browser-root=NOT_FOUND" >> $GITHUB_OUTPUT
          else
            echo "browser-root=$BROWSER_ROOT" >> $GITHUB_OUTPUT

            # 列出所有目录
            echo "" | tee -a "$LOG_FILE"
            echo "=== 浏览器根目录内容 ===" | tee -a "$LOG_FILE"
            ls -la "$BROWSER_ROOT" 2>&1 | tee -a "$LOG_FILE" || dir "$BROWSER_ROOT" 2>&1 | tee -a "$LOG_FILE"
            echo "" | tee -a "$LOG_FILE"

            # 查找浏览器目录
            echo "=== 浏览器目录列表 ===" | tee -a "$LOG_FILE"
            for browser_dir in "$BROWSER_ROOT"/*; do
              if [ -d "$browser_dir" ]; then
                echo "目录: $browser_dir" | tee -a "$LOG_FILE"
                du -sh "$browser_dir" 2>&1 | tee -a "$LOG_FILE" || echo "大小: 无法获取" | tee -a "$LOG_FILE"
              fi
            done
            echo "" | tee -a "$LOG_FILE"
          fi
        shell: bash
        continue-on-error: true

      - name: 查找浏览器可执行文件 (Linux/macOS)
        if: runner.os != 'Windows'
        id: find-executables-unix
        run: |
          LOG_FILE="${{ runner.temp }}/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt"

          echo "" | tee -a "$LOG_FILE"
          echo "=== 正在查找浏览器可执行文件 (Linux/macOS) ===" | tee -a "$LOG_FILE"
          echo "" | tee -a "$LOG_FILE"

          BROWSER_ROOT="${{ steps.find-browsers.outputs.browser-root }}"

          if [ "$BROWSER_ROOT" == "NOT_FOUND" ] || [ -z "$BROWSER_ROOT" ]; then
            echo "::warning::跳过可执行文件搜索 - 未找到浏览器根目录" | tee -a "$LOG_FILE"
            exit 0
          fi

          # 使用 find 查找所有浏览器相关文件
          echo "=== 使用 find 命令搜索浏览器二进制文件 ===" | tee -a "$LOG_FILE"
          echo "" | tee -a "$LOG_FILE"

          if [ "$RUNNER_OS" == "macOS" ]; then
            # macOS 查找 .app 和可执行文件
            find "$BROWSER_ROOT" -type f \( -name "Google Chrome for Testing" -o -name "firefox" -o -name "Playwright" \) -o -type d -name "*.app" 2>/dev/null | while read -r path; do
              echo "找到: $path" | tee -a "$LOG_FILE"
              if [ -f "$path" ]; then
                ls -lh "$path" | tee -a "$LOG_FILE"
                if [ -x "$path" ]; then
                  "$path" --version 2>&1 | head -1 | tee -a "$LOG_FILE" || echo "无法获取版本" | tee -a "$LOG_FILE"
                fi
              fi
              echo "" | tee -a "$LOG_FILE"
            done
          else
            # Linux 查找可执行文件
            find "$BROWSER_ROOT" -type f \( -name "chrome" -o -name "firefox" -o -name "pw_run.sh" \) 2>/dev/null | while read -r path; do
              echo "找到: $path" | tee -a "$LOG_FILE"
              ls -lh "$path" | tee -a "$LOG_FILE"
              if [ -x "$path" ] && [[ "$path" != *"pw_run.sh"* ]]; then
                "$path" --version 2>&1 | head -1 | tee -a "$LOG_FILE" || echo "无法获取版本" | tee -a "$LOG_FILE"
              fi
              echo "" | tee -a "$LOG_FILE"
            done
          fi
        shell: bash
        continue-on-error: true

      - name: 查找浏览器可执行文件 (Windows)
        if: runner.os == 'Windows'
        id: find-executables-windows
        run: |
          $LogFile = "$env:RUNNER_TEMP\test-log-${{ matrix.os }}-${{ matrix.arch }}.txt"

          "" | Out-File -Append -FilePath $LogFile
          "=== 正在查找浏览器可执行文件 (Windows) ===" | Tee-Object -Append -FilePath $LogFile
          "" | Out-File -Append -FilePath $LogFile

          $BrowserRoot = "${{ steps.find-browsers.outputs.browser-root }}"

          if ($BrowserRoot -eq "NOT_FOUND" -or [string]::IsNullOrEmpty($BrowserRoot)) {
            "::warning::跳过可执行文件搜索 - 未找到浏览器根目录" | Tee-Object -Append -FilePath $LogFile
            exit 0
          }

          # 使用 Where.exe (Windows 命令) 快速查找
          "=== 使用 Where 命令搜索浏览器二进制文件 ===" | Tee-Object -Append -FilePath $LogFile
          "" | Out-File -Append -FilePath $LogFile

          # 直接在已知路径中查找，避免递归搜索
          $BrowserDirs = Get-ChildItem -Path $BrowserRoot -Directory -ErrorAction SilentlyContinue

          foreach ($dir in $BrowserDirs) {
            "检查目录: $($dir.Name)" | Tee-Object -Append -FilePath $LogFile
            
            # 查找主要可执行文件（只在第一层子目录中查找）
            $exeFiles = Get-ChildItem -Path $dir.FullName -Recurse -Depth 2 -Include "chrome.exe","firefox.exe","Playwright.exe" -ErrorAction SilentlyContinue
            
            foreach ($exe in $exeFiles) {
              "  找到: $($exe.Name)" | Tee-Object -Append -FilePath $LogFile
              "  路径: $($exe.FullName)" | Tee-Object -Append -FilePath $LogFile
              "  大小: $([math]::Round($exe.Length / 1MB, 2)) MB" | Tee-Object -Append -FilePath $LogFile
              "" | Out-File -Append -FilePath $LogFile
            }
          }
        shell: pwsh
        continue-on-error: true

      - name: 使用 Playwright CLI 验证安装
        run: |
          # 设置日志文件路径
          if [ "$RUNNER_OS" == "Windows" ]; then
            LOG_FILE=$(cygpath -u "$RUNNER_TEMP")/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt
          else
            LOG_FILE="${{ runner.temp }}/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt"
          fi

          echo "" | tee -a "$LOG_FILE"
          echo "=== 使用 Playwright CLI 验证安装 ===" | tee -a "$LOG_FILE"
          echo "" | tee -a "$LOG_FILE"

          echo "--- 列出已安装的浏览器 ---" | tee -a "$LOG_FILE"
          npx playwright install --dry-run 2>&1 | tee -a "$LOG_FILE" || true

          echo "" | tee -a "$LOG_FILE"
          echo "--- Playwright 版本 ---" | tee -a "$LOG_FILE"
          npx playwright --version 2>&1 | tee -a "$LOG_FILE"
          echo "" | tee -a "$LOG_FILE"
        shell: bash
        continue-on-error: true

      - name: 生成摘要报告
        if: always()
        id: summary
        run: |
          # 设置日志文件路径
          if [ "$RUNNER_OS" == "Windows" ]; then
            LOG_FILE=$(cygpath -u "$RUNNER_TEMP")/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt
          else
            LOG_FILE="${{ runner.temp }}/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt"
          fi

          echo "=== 正在生成摘要报告 ===" | tee -a "$LOG_FILE"

          {
            echo "## 浏览器安装测试报告"
            echo ""
            echo "### 环境信息"
            echo "- **操作系统**: ${{ matrix.os }}"
            echo "- **架构**: ${{ matrix.arch }}"
            echo "- **运行器**: ${{ matrix.runner }}"
            echo "- **状态**: ${{ steps.install-browsers.outcome }}"
            echo ""

            echo "### 安装结果"
            if [ "${{ steps.install-browsers.outputs.exit-code }}" == "0" ]; then
              echo "✅ **成功** - Playwright 浏览器安装成功"
            else
              echo "❌ **失败** - 安装失败，退出码: ${{ steps.install-browsers.outputs.exit-code }}"
            fi
            echo ""

            echo "### 浏览器根目录"
            if [ "${{ steps.find-browsers.outputs.browser-root }}" == "NOT_FOUND" ]; then
              echo "⚠️ 未找到浏览器根目录"
            else
              echo "\`${{ steps.find-browsers.outputs.browser-root }}\`"
            fi
            echo ""

            echo "### 完整日志"
            echo "详细日志已上传至 Artifacts，文件名: \`test-log-${{ matrix.os }}-${{ matrix.arch }}.txt\`"

          } >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: 上传测试日志
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-log-${{ matrix.os }}-${{ matrix.arch }}
          path: ${{ runner.temp }}/test-log-${{ matrix.os }}-${{ matrix.arch }}.txt
          if-no-files-found: warn
          retention-days: 7

  summary:
    name: 安装测试汇总
    runs-on: ubuntu-latest
    needs: test-installation
    if: always()
    steps:
      - name: 下载所有测试日志
        uses: actions/download-artifact@v4
        with:
          pattern: test-log-*
          path: logs
          merge-multiple: true

      - name: 合并并压缩日志
        run: |
          cd logs
          ls -lh
          zip -9 ../all-test-logs.zip *.txt
          cd ..
          ls -lh all-test-logs.zip

      - name: 上传合并的日志压缩包
        uses: actions/upload-artifact@v4
        with:
          name: all-test-logs
          path: all-test-logs.zip
          retention-days: 30
          compression-level: 0

      - name: 生成测试汇总报告
        run: |
          echo "# 浏览器安装测试汇总" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "所有平台测试已完成。" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 日志文件" >> $GITHUB_STEP_SUMMARY
          echo "所有平台的测试日志已合并压缩至 \`all-test-logs.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 包含的日志文件:" >> $GITHUB_STEP_SUMMARY
          cd logs
          for log in *.txt; do
            size=$(du -h "$log" | cut -f1)
            echo "- \`$log\` ($size)" >> $GITHUB_STEP_SUMMARY
          done
